## Typesï¼ˆfn item vs fn pointerï¼‰

```rust
let x = bar::<i32>;
// x is fn item and is zero-sized

fn bar() {}

fn baz(_: fn(u32) -> u32) {}

baz(bar::<i32>);
// here param is a fn pointer and has a size of 8

// a fn item can be convert to a fn pointer through generating code
````

### è¯´æ˜

- **fn itemï¼ˆå‡½æ•°é¡¹ï¼‰**
    
    - `bar::<i32>` ä¸æ˜¯å‡½æ•°åœ°å€
        
    - è€Œæ˜¯â€œè¿™ä¸ªå…·ä½“å‡½æ•°æœ¬èº«â€çš„ä¸€ä¸ªå€¼
        
    - ç±»å‹æ˜¯å”¯ä¸€çš„ã€ç¼–è¯‘æœŸå·²çŸ¥
        
    - ä¸éœ€è¦ä»»ä½•è¿è¡Œæ—¶æ•°æ® â†’ **ZSTï¼ˆzero-sized typeï¼‰**
        
    
    ğŸ‘‰ å¯ä»¥ç†è§£ä¸ºï¼š
    
    > â€œç¼–è¯‘å™¨å·²ç»çŸ¥é“ä½ è¦è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Œä¸ç”¨å­˜åœ°å€â€
    
- **fn pointerï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰**
    
    ```rust
    fn(u32) -> u32
    ```
    
    - çœŸæ­£çš„è¿è¡Œæ—¶å€¼
        
    - æœ¬è´¨æ˜¯ä»£ç æ®µä¸­çš„åœ°å€
        
    - 64 ä½å¹³å°é€šå¸¸æ˜¯ **8 å­—èŠ‚**
        
- **ä¸ºä»€ä¹ˆ `baz(bar::<i32>)` èƒ½è¿‡ï¼Ÿ**
    
    Rust æœ‰ä¸€æ¡ **coercion è§„åˆ™**ï¼š
    
    ```text
    fn item  â†’  fn pointer
    ```
    
    ç¼–è¯‘å™¨ä¼šï¼š
    
    - ä¸ºè¯¥å‡½æ•°å®ä¾‹ç”Ÿæˆä»£ç å…¥å£
        
    - æŠŠå…¥å£åœ°å€å½“ä½œ `fn` æŒ‡é’ˆä¼ å…¥
        
    
    âš ï¸ è¿™æ˜¯è¯­è¨€çº§ç‰¹ä¾‹ï¼Œä¸æ˜¯ trait è¡Œä¸ºã€‚
    

---

## Traitï¼ˆFn / FnMut / FnOnceï¼‰

```rust
let f = || {};
baz(f);
quox(f);
// when closure does not capture something, it has trait Fn
// Fn -> FnMut -> FnOnce

fn baz(_: fn()) {}

fn quox<F>(f: F)
where 
	F: Fn()
{}
```

### è¯´æ˜

### 1. é—­åŒ…çš„æœ¬è´¨

- æ¯ä¸ªé—­åŒ…éƒ½ä¼šè¢«ç¼–è¯‘å™¨ç”Ÿæˆä¸€ä¸ª **åŒ¿å struct**
    
- æ˜¯å¦æ•è·å˜é‡ï¼Œå†³å®š struct æ˜¯å¦æœ‰å­—æ®µ
    

```rust
|| {}
```

- ä¸æ•è·å˜é‡
    
- struct æ²¡å­—æ®µ
    
- â‡’ **ZST**
    

---

### 2. ä¸ºä»€ä¹ˆèƒ½ä¼ ç»™ `fn()`ï¼Ÿ

Rust ç‰¹ä¾‹è§„åˆ™ï¼š

> **ä¸æ•è·ç¯å¢ƒçš„é—­åŒ…ï¼Œå¯ä»¥è‡ªåŠ¨é€€åŒ–ä¸º fn pointer**

```text
closure (ZST) â†’ fn()
```

âš ï¸ è¿™æ˜¯ç¡¬ç¼–ç è§„åˆ™ï¼Œä¸æ˜¯é€šè¿‡ trait å®ç°çš„ã€‚

---

### 3. ä¸ºä»€ä¹ˆ `quox(f)` èƒ½è¿‡ï¼Ÿ

```rust
fn quox<F: Fn()>(f: F)
```

- `F` åœ¨ç¼–è¯‘æœŸç¡®å®š
    
- å•æ€åŒ–
    
- é™æ€åˆ†å‘ã€å¯å†…è”
    
- **é›¶è¿è¡Œæ—¶å¼€é”€**
    

ğŸ‘‰ æ¨èçš„é«˜æ€§èƒ½å†™æ³•ã€‚

---

### 4. Fn / FnMut / FnOnce å…³ç³»

```text
Fn âŠ† FnMut âŠ† FnOnce
```

- `Fn`ï¼š`&self`
    
- `FnMut`ï¼š`&mut self`
    
- `FnOnce`ï¼š`self`
    

---

## æ•è·å˜é‡æ—¶çš„åŒºåˆ«

```rust
let z = String::new();

let f = || {
	let _ = z;
};
```

- æ•è·ä¸å¯å˜å€Ÿç”¨
    
- å¯å¤šæ¬¡è°ƒç”¨
    
- â‡’ `Fn`
    

---

```rust
let f = || {
	z.clear();
};
```

- æ•è·å¯å˜å€Ÿç”¨
    
- éœ€è¦ `&mut self`
    
- â‡’ `FnMut`
    

---

```rust
let f = || {
	drop(z);
};
```

- æ•è·æ‰€æœ‰æƒ
    
- åªèƒ½è°ƒç”¨ä¸€æ¬¡
    
- â‡’ `FnOnce`
    

---

## moveï¼ˆè½¬ç§»æ‰€æœ‰æƒ / å»¶é•¿ç”Ÿå‘½å‘¨æœŸï¼‰

```rust
fn make_fn() -> impl Fn {
	let x = String::new();
	
	let f = move || {
		println!("{}", x);
	}
}
```

### è¯´æ˜

- é»˜è®¤é—­åŒ…æŒ‰ **å€Ÿç”¨** æ•è·
    
- `x` æ˜¯å±€éƒ¨å˜é‡ï¼Œå‡½æ•°è¿”å›åä¼šè¢«é”€æ¯
    
- å¿…é¡»ä½¿ç”¨ `move` æŠŠ `x` ç§»å…¥ closure
    

ç­‰ä»·æ¨¡å‹ï¼š

```rust
struct Closure {
    x: String,
}
```

âš ï¸ `move` â‰  ä¸€å®šæ˜¯ `FnOnce`  
æ˜¯å¦æ˜¯ `FnOnce` å–å†³äºæ˜¯å¦ **æ¶ˆè€—å­—æ®µ**

---

## dyn Fnï¼ˆtrait object / èƒ–æŒ‡é’ˆï¼‰

```rust
let f = || {};

let x: &dyn Fn() = &f;
let x: &mut dyn FnMut() = &f;
// &mut æ‰èƒ½è°ƒç”¨ FnMut

let x: Box<dyn FnOnce()> = Box::new(f);
// FnOnce å¿…é¡»æ‹¥æœ‰ closure
```

### è¯´æ˜

### 1. ä»€ä¹ˆæ˜¯ dyn Fnï¼Ÿ

- `dyn Fn()` æ˜¯ trait object
    
- ç¼–è¯‘æœŸä¸çŸ¥é“å…·ä½“ç±»å‹
    
- åªèƒ½è¿è¡Œæ—¶åˆ†å‘
    

---

### 2. èƒ–æŒ‡é’ˆæ¨¡å‹

```text
&dyn Fn() =
    ( data_ptr , vtable_ptr )
```

- `data_ptr` â†’ closure structï¼ˆæ•è·ç¯å¢ƒï¼‰
    
- `vtable_ptr` â†’ call / drop / size / align
    

ğŸ‘‰ è¿™å°±æ˜¯ **èƒ–æŒ‡é’ˆï¼ˆ2 ä¸ªæŒ‡é’ˆï¼‰**

---

### 3. ä¸ºä»€ä¹ˆ FnOnce åªèƒ½ç”¨ Boxï¼Ÿ

- `FnOnce::call_once(self)`
    
- éœ€è¦ **æ‰€æœ‰æƒ**
    
- ä¸èƒ½ç”¨ `&dyn FnOnce()`
    

---

## const fnï¼ˆç¼–è¯‘æœŸé—­åŒ…ï¼Œå‰æ²¿ç‰¹æ€§ï¼‰

```rust
// nightly only
const fn foo<F: ~const Fn()>(f: F) {
	
}
// a const fn requires everything inside to be const
```

### è¯´æ˜

- `const fn` åœ¨ **ç¼–è¯‘æœŸæ‰§è¡Œ**
    
- ä¸å…è®¸ runtime è¡Œä¸º
    
- `~const Fn()` è¡¨ç¤ºï¼š
    
    - `Fn::call` ä¹Ÿæ˜¯ const çš„
        

âš ï¸ éå¸¸å‰æ²¿ï¼Œç›®å‰ç¨³å®š Rust åŸºæœ¬ç”¨ä¸åˆ°
